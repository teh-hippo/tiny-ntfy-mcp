name: Release

on:
  workflow_run:
    workflows: [Validate]
    types: [completed]
    branches: [main]

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v7

      - name: Python Semantic Release
        id: semantic_release
        uses: python-semantic-release/python-semantic-release@v10
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        if: ${{ steps.semantic_release.outputs.released == 'true' && steps.semantic_release.outputs.is_prerelease == 'false' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tagName = "${{ steps.semantic_release.outputs.tag }}";
            const tagRef = await github.rest.git.getRef({
              owner,
              repo,
              ref: `tags/${tagName}`,
            });

            let sha = tagRef.data.object.sha;
            if (tagRef.data.object.type === "tag") {
              const tagObject = await github.rest.git.getTag({
                owner,
                repo,
                tag_sha: sha,
              });
              sha = tagObject.data.object.sha;
            }

            try {
              await github.rest.git.updateRef({
                owner,
                repo,
                ref: "tags/latest",
                sha,
                force: true,
              });
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }

              await github.rest.git.createRef({
                owner,
                repo,
                ref: "refs/tags/latest",
                sha,
              });
            }
